# -*- coding: utf-8 -*-

import logging
import discord
import google.generativeai as genai

# --- ูพฺฉุฑุจูุฏโูุง ---
# ุฏุฑ ุงู ุจุฎุด ุจุงุฏ ุงุทูุงุนุงุช ูุญุฑูุงูู ุฎูุฏ ุฑุง ูุงุฑุฏ ฺฉูุฏ.
# ูุดุฏุงุฑ: ุงู ุงุทูุงุนุงุช ุฑุง ุจุง ฺฉุณ ุจู ุงุดุชุฑุงฺฉ ูฺฏุฐุงุฑุฏ.

# 1. ุชูฺฉู ุฑุจุงุช ุฏุณฺฉูุฑุฏ ุฎูุฏ ุฑุง ุงูุฌุง ูุฑุงุฑ ุฏูุฏ
# ุงู ุชูฺฉู ุฑุง ุงุฒ ุจุฎุด "Bot" ุฏุฑ ูพูุฑุชุงู ุชูุณุนูโุฏููุฏฺฏุงู ุฏุณฺฉูุฑุฏ ุฏุฑุงูุช ฺฉูุฏ.
DISCORD_BOT_TOKEN = "161a50061eef65339bcc0311524ffce27849f2c50c89611ba92d216cde5919b6"

# 2. ฺฉูุฏ API ุฎูุฏ ุจุฑุง Gemini ุฑุง ุงูุฌุง ูุฑุงุฑ ุฏูุฏ
# ุงู ฺฉูุฏ ุฑุง ูโุชูุงูุฏ ุจู ุตูุฑุช ุฑุงฺฏุงู ุงุฒ Google AI Studio ุฏุฑุงูุช ฺฉูุฏ.
GEMINI_API_KEY = "AIzaSyARLbIN33FrsjOBSL16duYsfZz4-DE1qLg"

# ูพฺฉุฑุจูุฏ ูุงฺฏู ุจุฑุง ููุงุด ุงุทูุงุนุงุช ุฏุฑ ุชุฑููุงู
logging.basicConfig(level=logging.INFO)

# ูพฺฉุฑุจูุฏ ูุฏู ููุด ูุตููุน Gemini
try:
    genai.configure(api_key=GEMINI_API_KEY)
    model = genai.GenerativeModel('gemini-1.5-flash-latest')
    logging.info("ูุฏู Gemini ุจุง ููููุช ูพฺฉุฑุจูุฏ ุดุฏ.")
except Exception as e:
    logging.error(f"ุฎุทุง ุฏุฑ ูพฺฉุฑุจูุฏ Gemini: {e}")
    model = None

# --- ููุทู ุงุตู ุฑุจุงุช ุฏุณฺฉูุฑุฏ ---

# ุจุฑุง ุงูฺฉู ุฑุจุงุช ุจุชูุงูุฏ ูุญุชูุง ูพุงูโูุง ุฑุง ุจุฎูุงูุฏุ ุจุงุฏ Intents ุฑุง ูุนุงู ฺฉูู.
intents = discord.Intents.default()
intents.message_content = True

# ุณุงุฎุช ฺฉ ููููู ุงุฒ ฺฉูุงูุช ุฑุจุงุช ุจุง Intents ูุดุฎุต ุดุฏู
client = discord.Client(intents=intents)

@client.event
async def on_ready():
    """
    ุงู ุชุงุจุน ุฒูุงู ุงุฌุฑุง ูโุดูุฏ ฺฉู ุฑุจุงุช ุจุง ููููุช ุจู ุฏุณฺฉูุฑุฏ ูุชุตู ุดูุฏ.
    ฺฉ ูพุงู ุฏุฑ ุชุฑููุงู ฺุงูพ ูโฺฉูุฏ ุชุง ุงุฒ ุขููุงู ุจูุฏู ุฑุจุงุช ูุทูุฆู ุดูู.
    """
    print(f'ุฑุจุงุช ุจุง ูุงู ฺฉุงุฑุจุฑ {client.user} ุจุง ููููุช ุขููุงู ุดุฏ!')
    print('------')

@client.event
async def on_message(message):
    """
    ุงู ุชุงุจุน ุจู ุงุฒุง ูุฑ ูพุงู ฺฉู ุฏุฑ ุณุฑูุฑ ุงุฑุณุงู ุดูุฏุ ฺฉ ุจุงุฑ ุงุฌุฑุง ูโุดูุฏ.
    """
    # 1. ุงฺฏุฑ ูพุงู ุงุฑุณุงู ุดุฏู ุชูุณุท ุฎูุฏ ุฑุจุงุช ุจุงุดุฏุ ุขู ุฑุง ูุงุฏุฏู ูโฺฏุฑู.
    if message.author == client.user:
        return

    # 2. ุจุฑุฑุณ ูโฺฉูู ฺฉู ุขุง ุฑุจุงุช ุฏุฑ ูพุงู ููุดู (mention) ุดุฏู ุงุณุช ุง ุฎุฑ.
    # ุฑุจุงุช ููุท ุจู ูพุงูโูุง ูพุงุณุฎ ูโุฏูุฏ ฺฉู ุฏุฑ ุขู @ูุงู_ุฑุจุงุช ุฐฺฉุฑ ุดุฏู ุจุงุดุฏ.
    if client.user.mentioned_in(message):
        
        # 3. ุจุฑุฑุณ ูโฺฉูู ฺฉู ุขุง ูุฏู ููุด ูุตููุน ุขูุงุฏู ุจู ฺฉุงุฑ ุงุณุช.
        if not model:
            await message.channel.send("ูุชุงุณูุงูู ุฏุฑ ุญุงู ุญุงุถุฑ ุจู ุณุฑูุณ ููุด ูุตููุน ูุชุตู ูุณุชู. ูุทูุงู ุจุนุฏุงู ุชูุงุด ฺฉูุฏ.")
            return

        # 4. ูุชู ูพุงู ฺฉุงุฑุจุฑ ุฑุง ุชูุฒ ูโฺฉูู (ูุงู ุฑุจุงุช ุฑุง ุงุฒ ุขู ุญุฐู ูโฺฉูู).
        user_message = message.content.replace(f'<@!{client.user.id}>', '').strip()
        user_message = user_message.replace(f'<@{client.user.id}>', '').strip()

        if not user_message:
            await message.channel.send("ุณูุงู! ฺุทูุฑ ูุชููู ฺฉูฺฉุช ฺฉููุ ูุทูุงู ุณูุงูุช ุฑู ุจุนุฏ ุงุฒ ููุดู ฺฉุฑุฏู ูู ุจููุณ.")
            return

        try:
            # 5. ฺฉ ูพุงู "ุฏุฑ ุญุงู ูพุฑุฏุงุฒุด" ุจุฑุง ฺฉุงุฑุจุฑ ุงุฑุณุงู ูโฺฉูู.
            async with message.channel.typing():
                # 6. ูพุงู ฺฉุงุฑุจุฑ ุฑุง ุจู ูุฏู Gemini ุงุฑุณุงู ฺฉุฑุฏู ู ููุชุธุฑ ูพุงุณุฎ ูโูุงูู.
                response = model.generate_content(user_message)

                # 7. ูพุงุณุฎ ุฏุฑุงูุช ุดุฏู ุฑุง ุฏุฑ ฺฉุงูุงู ุฏุณฺฉูุฑุฏ ุงุฑุณุงู ูโฺฉูู.
                # ุงฺฏุฑ ูพุงุณุฎ ุทููุงู ุจูุฏุ ุขู ุฑุง ุจู ฺูุฏ ุจุฎุด ุชูุณู ูโฺฉูู.
                if len(response.text) > 2000:
                    for chunk in [response.text[i:i + 2000] for i in range(0, len(response.text), 2000)]:
                        await message.channel.send(chunk)
                else:
                    await message.channel.send(response.text)

        except Exception as e:
            # ุฏุฑ ุตูุฑุช ุจุฑูุฒ ุฎุทุงุ ุขู ุฑุง ุฏุฑ ูุงฺฏ ุซุจุช ฺฉุฑุฏู ู ุจู ฺฉุงุฑุจุฑ ุงุทูุงุน ูโุฏูู.
            logging.error(f"ุฎุทุง ุฏุฑ ุฏุฑุงูุช ูพุงุณุฎ ุงุฒ Gemini: {e}")
            await message.channel.send("ุงูู! ู ูุดฺฉู ูพุด ุงููุฏ. ูุชููุณุชู ุฌูุงุจ ุณูุงูุช ุฑู ูพุฏุง ฺฉูู. ๐")


def main():
    """
    ุชุงุจุน ุงุตู ฺฉู ุฑุจุงุช ุฑุง ุฑุงูโุงูุฏุงุฒ ู ุงุฌุฑุง ูโฺฉูุฏ.
    """
    if DISCORD_BOT_TOKEN == "YOUR_DISCORD_BOT_TOKEN" or GEMINI_API_KEY == "YOUR_GEMINI_API_KEY":
        print("!!! ูุดุฏุงุฑ: ูุทูุงู ุชูฺฉู ุฑุจุงุช ุฏุณฺฉูุฑุฏ ู ฺฉูุฏ API Gemini ุฑุง ุฏุฑ ฺฉุฏ ูุฑุงุฑ ุฏูุฏ.")
        return
    
    try:
        print("ุฑุจุงุช ุฏุฑ ุญุงู ุงุฌุฑุงุณุช...")
        client.run(DISCORD_BOT_TOKEN)
    except discord.errors.LoginFailure:
        print("ุฎุทุง: ุชูฺฉู ุฑุจุงุช ุฏุณฺฉูุฑุฏ ูุงูุนุชุจุฑ ุงุณุช. ูุทูุงู ุชูฺฉู ุฑุง ุจุฑุฑุณ ฺฉูุฏ.")
    except Exception as e:
        print(f"ุฎุทุง ูพุดโุจู ูุดุฏู: {e}")

if __name__ == '__main__':
    main()
